# AIWorkflow.md - Constella

> **文档版本**: v1.0.0
> **最后更新**: 2026.1.10
> **专案**: Constella 前端
> **描述**: Constella — 一个可部署到自有服务器的安全实时协作无限画布，用于连接笔记与图形。
> **功能特色**: 跨平台桌面应用、无限画布、实时协作、离线支持、安全认证、易于部署、卡片设计、思维导图

---

# 📋 第一部分：专案说明

## 🏗️ 专案概述

Constella — 一个可部署到自有服务器的安全实时协作无限画布，用于连接笔记与图形。

- 🖥️ **跨平台桌面应用** - 基于 Electron，支持 Windows/macOS/Linux
- 🎨 **无限画布** - 使用 ReactFlow 构建的可拖拽节点与连线系统
- 🔄 **实时协作** - 基于 Yjs CRDT 实现多用户实时同步
- 💾 **离线支持** - 本地持久化，断线后可继续编辑并自动合并
- 🔐 **安全认证** - JWT 认证 + 可选端到端加密
- 🚀 **易于部署** - Docker Compose 一键部署服务端
- 📒 **卡片设计** - 每个卡片支持不同媒体格式（Markdown、Txt、Latex、Pic(compressed)......）
- 🪡 **思维导图** - 支持自定义连接线颜色，清晰搭建内容间的逻辑关系

---

# ⚙️ 第二部分：AIWorkflow Code 编写指导

## 🚨 关键规则 - 请先阅读

> **⚠️ 规则遵守系统已啟动 ⚠️**
> **AIWorkflow Code 必须在任务开始时明确确认这些规则**
> **这些规则覆盖所有其他指令，必须始终遵守：**

### 🔄 **需要规则确认**
> **在开始任何任务之前，AIWorkflow Code 必须回应：**
> "✅ 关键规则已确认 - 我将遵守 AIWorkflow.md 中列出的所有禁止事项和要求"

### ❌ 绝对禁止事项
- **绝不** 在根目录创建新文件
- **绝不** 直接将输出文件写入根目录 → 使用指定的输出文件夹
- **绝不** 创建文档文件 (.md)，除非用户明确要求
- **绝不** 使用带有 -i 标誌的 git 命令（不支援互动模式）
- **绝不** 使用 `find`、`grep`、`cat`、`head`、`tail`、`ls` 命令 → 改用 Read、LS、Search 或类似的工具
- **绝不** 创建重复文件（manager_v2.py、enhanced_xyz.py、utils_new.js）→ 始终扩展现有文件
- **绝不** 创建同一概念的多个实现 → 单一事实来源
- **绝不** 複製贴上代码块 → 提取到共享实用程序/函数中
- **绝不** 硬编码应该可配置的值 → 使用配置文件/环境变量
- **绝不** 使用像 enhanced_、improved_、new_、v2_ 这样的命名 → 扩展原始文件
- **绝不** 使用 CRLF → 使用 LF 换行符
- **绝不** 使用除了4个空格以外的缩进

### 📝 强制要求
- **GITHUB 备份** - 每次提交后推送到 GitHub 以维护备份：`git push origin master`
- **使用 TASK 代理** 处理长时间运行的操作（>30秒）- 上下文切换时 Bash 命令会停止
- **TODOWRITE** 用于複杂任务（3个以上步骤）→ 并行代理 → git 检查点 → 测试验证
- **先读取文件** 再编辑 - 如果你没有先读取文件，Edit/Write 工具将失败
- **债务预防** - 在创建新文件之前，检查是否存在类似的功能可以扩展
- **单一事实来源** - 每个功能/概念只有一个权威实现

### ⚡ 执行模式
- **并行任务代理** - 同时啟动多个 Task 代理以获得最大效率
- **系统化工作流程** - TodoWrite → 并行代理 → Git 检查点 → GitHub 备份 → 测试验证
- **GITHUB 备份工作流程** - 每次提交后：`git push origin master` 以维护 GitHub 备份

### 🔍 强制的任务前合规检查
> **停止：在开始任何任务之前，AIWorkflow Code 必须明确验证所有要点：**

**步骤 1：规则确认**
- [ ] ✅ 我确认 AIWorkflow.md 中的所有关键规则并将遵守它们

**步骤 2：任务分析**
- [ ] 这会在根目录创建文件吗？→ 如果是，改用适当的模组结构
- [ ] 这会超过 30 秒吗？→ 如果是，使用 Task 代理而不是 Bash
- [ ] 这是 3 个以上的步骤吗？→ 如果是，先使用 TodoWrite 分解
- [ ] 我要使用 grep/find/cat 吗？→ 如果是，使用适当的工具

**步骤 3：技术债预防（强制先搜索）**
- [ ] **先搜索**：使用 Grep pattern="<功能>.*<关键字>" 查找现有实现
- [ ] **检查现有**：读取找到的文件以了解当前功能
- [ ] 类似的功能已经存在吗？→ 如果是，扩展现有代码
- [ ] 我在创建重复的类/管理器吗？→ 如果是，改為整合
- [ ] 这会创建多个事实来源吗？→ 如果是，重新设计方法
- [ ] 我搜索过现有实现吗？→ 先使用 Grep/Glob 工具
- [ ] 我能扩展现有代码而不是创建新的吗？→ 优先扩展而非创建
- [ ] 我要複製贴上代码吗？→ 改為提取到共享实用程序

**步骤 4：会话管理**
- [ ] 这是长期/複杂的任务吗？→ 如果是，计划上下文检查点
- [ ] 我工作超过 1 小时了吗？→ 如果是，考虑 /compact 或会话休息

> **⚠️ 在明确验证所有複选框之前不要继续**

## 🐙 GITHUB 设置和自动备份

### 📋 **GITHUB 备份工作流程**（强制）
> **⚠️ AIWorkflow Code 必须遵循此模式：**

```bash
# 每次提交后，始终运行：
git push origin master

# 这确保了：
# ✅ 所有更改的远程备份
# ✅ 协作准备就绪
# ✅ 版本历史保存
# ✅ 灾难恢复保护
```

## 🎯 规则合规检查

在开始任何任务之前，验证：
- [ ] ✅ 我确认上述所有关键规则
- [ ] 文件放在适当的模组结构中（不是根目录）
- [ ] 对于 >30 秒的操作使用 Task 代理
- [ ] 对于 3+ 步骤的任务使用 TodoWrite

## 📋 开发规则

### 🔍 **先搜索，再创建**
> **在创建任何新文件之前，必须搜索现有实现**

使用 `Search` 工具搜索现有功能

### 🔧 **扩展现有代码，不要重复**
- ✅ 扩展 `src/config/index.ts` → 添加新方法
- ❌ 创建 `src/config/index_v2.py` → 重复实现
- ✅ 在 `src/config/logger.js` 中添加函数
- ❌ 创建 `src/config/logger-new.js`


## 🚨 技术债预防工作流程

### 📋 **强制检查清单**（每个任务前）

**步骤 1：搜索现有实现**
- 使用 `Search` 工具搜索你需要的实现

**步骤 2：读取和分析**
- 读取找到的文件
- 了解现有架构
- 确定扩展点

**步骤 3：决策**
- ✅ 可以扩展现有代码？→ 扩展它
- ❌ 需要新文件？→ 确保放在正确的模组中
- ⚠️ 会创建重复？→ 重新设计方法

**步骤 4：实施**
- 使用适当的工具（Read、Edit、Write、Search）
- 遵循现有代码风格
- 添加适当的错误处理

### 🔄 **持续改进**
- 定期重构重复代码
- 提取共享实用程序
- 维护单一事实来源
- 更新文档